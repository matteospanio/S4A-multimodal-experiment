{% extends 'base.html.twig' %}

{% block title %}{{ task_name }} - S4A Experiment{% endblock %}

{% block body %}
<div class="container">
    <div class="app-header">
        <h1 class="app-title">{{ task_name }}</h1>
        {% if task_type == 1 %}
            <p class="app-subtitle">Listen to both audio stimuli, smell the perfume, then choose which audio best matches the scent</p>
        {% else %}
            <p class="app-subtitle">Listen to the audio stimulus, then choose which of the two perfumes best matches</p>
        {% endif %}
    </div>

    {{ form_start(form, {'attr': {'id': 'trial-form'}}) }}
        {{ form_widget(form.choice, {'attr': {'id': 'choice-input', 'style': 'display: none;'}}) }}
        <div class="row">
            <div class="col-md-12">
                {% if task_type == 1 %}
                    {# Task 1: Two audio stimuli + one perfume #}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 class="card-title">Audio Stimuli</h4>

                                    <div class="audio-control">
                                        <h5>Audio Option A</h5>
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.songs[0].url }}" type="audio/wav">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>

                                    <div class="audio-control">
                                        <h5>Audio Option B</h5>
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.songs[1].url }}" type="audio/wav">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 class="card-title">Perfume to Smell</h4>
                                    <div class="icon-lg text-primary mb-3">
                                        {{ trial.flavor.icon }}
                                    </div>
                                    <p class="card-text">Please smell the perfume sample provided</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4 class="text-center mb-3">Which audio best matches the perfume?</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-controller="stimulus-selector"
                                         data-stimulus-selector-choice-value="{{ trial.songs[0].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                üéµ
                                            </div>
                                            <h5>Choose Audio A</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-controller="stimulus-selector"
                                         data-stimulus-selector-choice-value="{{ trial.songs[1].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                üéµ
                                            </div>
                                            <h5>Choose Audio B</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}
                    {# Task 2: One audio stimulus + two perfume choices #}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-body text-center">
                                    <h4 class="card-title">Audio Stimulus</h4>
                                    <div class="audio-control">
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.song.url }}" type="audio/wav">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h4 class="text-center mb-3">Which perfume best matches the audio?</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-controller="stimulus-selector"
                                         data-stimulus-selector-choice-value="{{ trial.flavors[0].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                {{ trial.flavors[0].icon }}
                                            </div>
                                            <h5>Perfume Option 1</h5>
                                            <p class="card-text">Smell the {{ trial.flavors[0] }} sample</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-controller="stimulus-selector"
                                         data-stimulus-selector-choice-value="{{ trial.flavors[1].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                {{ trial.flavors[1].icon }}
                                            </div>
                                            <h5>Perfume Option 2</h5>
                                            <p class="card-text">Smell the {{ trial.flavors[1] }} sample</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12 text-center">
                <button class="btn btn-secondary me-3" type="button" onclick="window.history.back()">
                    ‚Üê Back to Menu
                </button>
                <button class="btn btn-primary" id="submit-choice" type="submit" disabled>
                    Submit Choice ‚Üí
                </button>
            </div>
        </div>
    {{ form_end(form) }}
</div>

<script>
    // Aggiorna il campo hidden e abilita il submit quando una carta viene selezionata
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.stimulus-card[data-controller="stimulus-selector"]').forEach(card => {
            card.addEventListener('click', function () {
                document.getElementById('choice-input').value = card.getAttribute('data-stimulus-selector-choice-value');
                document.getElementById('submit-choice').disabled = false;
            });
        });
    });
</script>
{% endblock %}
