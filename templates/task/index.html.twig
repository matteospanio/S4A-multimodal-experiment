{% extends 'base.html.twig' %}

{% block title %}Trial - S4A Experiment{% endblock %}

{% block body %}
<div
    class="container"
    data-controller="stimulus-selector opened-modal"
    data-opened-modal-open-modal-value="{{ openModal ? 'true' : 'false' }}"
>
    <div class="app-header">
        {% if task_type == 1 %}
            <p class="app-subtitle">{{ 'task.m2f.instructions'|trans }}</p>
        {% else %}
            <p class="app-subtitle">{{ 'task.f2m.instructions'|trans }}</p>
        {% endif %}
    </div>

    <!-- Modal -->
    <div data-opened-modal-target="modal" class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">{{ 'task.consent.title'|trans }}</h1>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" role="alert">
                        <h4>TL;DR</h4>
                        <p>
                            {{ 'task.consent.tldr'|trans|raw|nl2br }}
                        </p>
                    </div>
                    <ol>
                        <li>
                            <p><strong>{{ 'task.consent.el1.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el1.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el2.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el2.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el3.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el3.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el4.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el4.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el5.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el5.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el6.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el6.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el7.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el7.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el8.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el8.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el9.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el9.description'|trans }}</p>
                        </li>
                        <li>
                            <p><strong>{{ 'task.consent.el10.section'|trans }}</strong></p>
                            <p>{{ 'task.consent.el10.description'|trans }}</p>
                        </li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">{{ 'task.consent.button'|trans }}</button>
                </div>
            </div>
        </div>
    </div>

    {{ form_start(form, {'action': path('app_task_submit', {'type': task_type, 'id': trial.id}), 'attr': {'id': 'trial-form'}}) }}
        {{ form_widget(form.choice, {'attr': {'data-stimulus-selector-target': 'choiceInput', 'style': 'display: none;'}}) }}
        <div class="row">
            <div class="col-md-12">
                {% if task_type == 1 %}
                    {# Task 1: Two audio stimuli + one perfume #}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 class="card-title">{{ 'task.audio.stimuli'|trans }}</h4>

                                    <div class="audio-control">
                                        <h5>{{ 'task.audio.option'|trans }} A</h5>
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.songs[0].urlPath }}" type="audio/wav">
                                            {{ 'task.audio.error'|trans }}
                                        </audio>
                                    </div>

                                    <div class="audio-control">
                                        <h5>{{ 'task.audio.option'|trans }} B</h5>
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.songs[1].urlPath }}" type="audio/wav">
                                            {{ 'task.audio.error'|trans }}
                                        </audio>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h4 class="card-title">{{ 'task.perfume.to_smell'|trans }}</h4>
                                    <div class="icon-lg text-primary mb-3">
                                        {{ trial.flavor.icon }}
                                    </div>
                                    <p class="card-text">{{ 'task.perfume.instruction'|trans }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4 class="text-center mb-3">{{ 'task.m2f.question'|trans }}</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-stimulus-selector-target="card"
                                         data-action="click->stimulus-selector#selectStimulus"
                                         id="{{ trial.songs[0].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                🎵
                                            </div>
                                            <h5>{{ 'task.choose'|trans }} {{ 'general.music'|trans }} A</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-stimulus-selector-target="card"
                                         data-action="click->stimulus-selector#selectStimulus"
                                         id="{{ trial.songs[1].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                🎵
                                            </div>
                                            <h5>{{ 'task.choose'|trans }} {{ 'general.music'|trans }} B</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}
                    {# Task 2: One audio stimulus + two perfume choices #}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-body text-center">
                                    <h4 class="card-title">{{ 'task.audio.stimulus'|trans }}</h4>
                                    <div class="audio-control">
                                        <audio controls preload="metadata">
                                            <source src="{{ trial.song.urlPath }}" type="audio/wav">
                                            {{ 'task.audio.error'|trans }}
                                        </audio>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h4 class="text-center mb-3">{{ 'task.f2m.question'|trans }}</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-stimulus-selector-target="card"
                                         data-action="click->stimulus-selector#selectStimulus"
                                         id="{{ trial.flavors[0].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                {{ trial.flavors[0].icon }}
                                            </div>
                                            <h5>{{ 'task.perfume.option'|trans }} 1</h5>
                                            <p class="card-text">{{ 'task.f2m.specific_instruction'|trans({'%flavor%': trial.flavors[0]}) }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card stimulus-card"
                                         data-stimulus-selector-target="card"
                                         data-action="click->stimulus-selector#selectStimulus"
                                         id="{{ trial.flavors[1].id }}">
                                        <div class="card-body text-center">
                                            <div class="icon-md text-primary">
                                                {{ trial.flavors[1].icon }}
                                            </div>
                                            <h5>{{ 'task.perfume.option'|trans }} 2</h5>
                                            <p class="card-text">{{ 'task.f2m.specific_instruction'|trans({'%flavor%': trial.flavors[1]}) }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12 text-center">
                {% if is_granted('ROLE_ADMIN') %}
                <a class="btn btn-secondary me-3" href="{{ path('app_home') }}">
                    ← {{ 'task.back'|trans }}
                </a>
                {% endif %}
                <button class="btn btn-primary" data-stimulus-selector-target="submitButton" type="submit" disabled>
                    {{ 'task.submit'|trans }} →
                </button>
            </div>
        </div>
    {{ form_end(form) }}
</div>
{% endblock %}
