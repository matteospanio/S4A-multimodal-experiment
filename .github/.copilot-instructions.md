# S4A-multimodal-experiment Copilot Instructions

This repository contains a Symfony-based web application for conducting multimodal sensory experiments. The application collects data on cross-sensory associations between music and perfume/flavors through two complementary tasks.

## Project Overview

**S4A-multimodal-experiment** is a Progressive Web Application (PWA) designed to collect experimental data on cross-modal perception. The experiment consists of two tasks:

1. **Task 1 (smells2music)**: Participants listen to a song while smelling two perfumes, then decide which perfume best matches the music
2. **Task 2 (musics2smell)**: Participants smell a perfume while listening to two songs, then choose which song best matches the scent

The application runs on tablets for data collection and includes an admin interface for managing stimuli and viewing results.

## Technology Stack

- **Backend**: Symfony 7.3+ with PHP 8.3+
- **Database**: PostgreSQL
- **Frontend**: Hotwire Stimulus + Turbo, Chart.js for data visualization
- **Admin Interface**: EasyAdmin Bundle
- **Testing**: PHPUnit
- **PWA**: Progressive Web App capabilities

## Key Architecture

### Entity Structure

- **`Flavor`**: Represents scent categories (4 main flavors)
  - Has many `Song` entities associated
  - Contains name, icon, and description
  
- **`Song`**: Audio stimuli linked to specific flavors
  - Contains URL, prompt, and expected flavor associations
  - Belongs to one `Flavor`
  
- **`Trial`**: Records experimental sessions
  - Two types: `SMELLS2MUSIC` and `MUSICS2SMELL`
  - Tracks task type and creation timestamp
  
- **`Participant`**: Stores participant information (optional demographics)
  
- **`User`**: Admin users for system management

### Core Services

- **`StimuliManager`**: Generates balanced, randomized stimulus combinations
  - Ensures equal presentation of all possible combinations (2^4 = 16)
  - Implements random but balanced selection logic
  
- **`DataCollector`**: Handles response recording and storage
  - Records participant votes for each trial
  - Manages data persistence to database
  
- **`Mathematician`**: Computes statistics and aggregations
  - Calculates percentages and averages for feedback
  - Prepares data for frontend visualization

## Development Guidelines

### Code Conventions

1. **Follow Symfony best practices**: Use attributes for routing, dependency injection, and ORM mapping
2. **Service-oriented architecture**: Business logic should be in services, not controllers
3. **Entity responsibility**: Keep entities focused on data structure and relationships
4. **Controller simplicity**: Controllers should be thin, delegating to services
5. **Repository pattern**: Use repositories for complex database queries

### Commands Available

- **`app:new:user`**: Create new users with optional admin privileges
  - Use `--admin` flag for administrator accounts
  - Supports interactive prompts or `--random` password generation

### Frontend Development

- **Stimulus Controllers**: Use for interactive components
- **Turbo**: Leverage for fast navigation without full page reloads
- **Chart.js**: Via Symfony UX for data visualization
- **Progressive Enhancement**: Ensure functionality works without JavaScript

### Database

- **Migrations**: Always create migrations for schema changes using `make:migration`
- **Fixtures**: Use for development data, especially the 4 core flavors
- **Relationships**: Maintain referential integrity through Doctrine relationships

### Testing

- **Controller Tests**: Test HTTP responses and routing
- **Service Tests**: Unit test business logic in services
- **Integration Tests**: Test complete workflows for both experiment tasks

## Experiment Logic Requirements

### Balance Requirements
- Each of the 2^4 = 16 possible combinations must be presented equally
- Random selection but globally balanced across all participants
- Labels should be presented in random order to avoid position bias

### Task 1 (smells2music) Flow
1. Random song selection associated with a specific flavor
2. Second random flavor selection (different from song's flavor)
3. Present both flavor labels in random order
4. Collect participant's choice
5. Store vote and show aggregated stats

### Task 2 (musics2smell) Flow
1. Random flavor selection
2. Two different songs from two different flavors
3. Present songs in random order
4. Collect participant's choice
5. Store vote and show aggregated stats

## Admin Interface

### Dashboard Requirements
- **Pie chart**: Show song count distribution across flavors
- **Time series**: Display song upload activity over time
- **CRUD operations**: Manage songs, flavors, and users
- **User management**: Admin-only user administration

### Content Management
- **Song upload**: Add new audio stimuli with flavor associations
- **Flavor management**: Configure the 4 main scent categories
- **User roles**: Distinguish between admin and regular users

## PWA Features

- **Offline capability**: Cache essential resources for tablet use
- **Install prompt**: Allow installation on tablets
- **App-like experience**: Full-screen mode suitable for experiments

## Development Setup

### Prerequisites
- PHP 8.3+
- Composer
- PostgreSQL

### Installation
```bash
composer install
php bin/console doctrine:database:create
php bin/console doctrine:migrations:migrate
# Create an admin user
php bin/console app:new:user --admin
```

### Development Server
```bash
symfony server:start
```

### Testing
```bash
symfony php bin/phpunit
```

## File Structure Conventions

- **Controllers**: Keep thin, delegate to services
- **Services**: Place business logic here
- **Entities**: Data structure and relationships only
- **Templates**: Use Twig, extend base template
- **Assets**: JavaScript in `assets/` directory using Stimulus

## Common Tasks

### Adding New Stimuli Management
1. Create entity if needed
2. Generate CRUD controller with `make:admin:crud`
3. Add to admin dashboard menu
4. Update `StimuliManager` if logic changes

### Implementing New Statistics
1. Add methods to `Mathematician` service
2. Create necessary database queries in repositories
3. Update templates with Chart.js components
4. Test calculations with realistic data

### Frontend Interactivity
1. Create Stimulus controller for behavior
2. Add data attributes to templates
3. Use Turbo for navigation
4. Maintain progressive enhancement

This project emphasizes user experience for experimental participants while providing powerful admin tools for researchers. When working on this codebase, always consider the dual nature of the application: participant-facing experiment interface and researcher-facing administration tools.
